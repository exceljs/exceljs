{"version":3,"sources":["../../../../../lib/xlsx/xform/book/workbook-xform.js"],"names":["_","require","utils","colCache","XmlStream","BaseXform","StaticXform","ListXform","DefinedNameXform","SheetXform","WorkbookViewXform","WorkbookPropertiesXform","WorkbookXform","module","exports","map","fileVersion","STATIC_XFORMS","workbookPr","bookViews","tag","count","childXform","sheets","definedNames","calcPr","inherits","WORKBOOK_ATTRIBUTES","xmlns","$","appName","lastEdited","lowestEdited","rupBuild","calcId","iterate","iterateCount","iterateDelta","prepare","model","worksheets","printAreas","index","forEach","sheet","pageSetup","printArea","definedName","name","ranges","localSheetId","push","printTitlesRow","titlesRows","split","length","concat","media","medium","i","type","render","xmlStream","openXml","StdDocAttributes","openNode","properties","views","closeNode","parseOpen","node","parser","parseText","text","parseClose","undefined","reconcile","rels","workbookRels","reduce","rel","Id","worksheet","rId","worksheetHash","Target","id","each","range","decodeEx","dimensions","longRange"],"mappings":"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","file":"workbook-xform.js","sourcesContent":["/**\n * Copyright (c) 2016 Guyon Roche\n * LICENCE: MIT - please refer to LICENCE file included with this module\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\n */\n\n'use strict';\n\nvar _ = require('../../../utils/under-dash');\n\nvar utils = require('../../../utils/utils');\nvar colCache = require('../../../utils/col-cache');\nvar XmlStream = require('../../../utils/xml-stream');\n\nvar BaseXform = require('../base-xform');\nvar StaticXform = require('../static-xform');\nvar ListXform = require('../list-xform');\nvar DefinedNameXform = require('./defined-name-xform');\nvar SheetXform = require('./sheet-xform');\nvar WorkbookViewXform = require('./workbook-view-xform');\nvar WorkbookPropertiesXform = require('./workbook-properties-xform');\n\nvar WorkbookXform = module.exports = function() {\n  this.map = {\n    fileVersion: WorkbookXform.STATIC_XFORMS.fileVersion,\n    workbookPr: new WorkbookPropertiesXform(),\n    bookViews: new ListXform({tag: 'bookViews', count: false, childXform: new WorkbookViewXform()}),\n    sheets: new ListXform({tag: 'sheets', count: false, childXform: new SheetXform()}),\n    definedNames: new ListXform({tag: 'definedNames', count: false, childXform: new DefinedNameXform()}),\n    calcPr: WorkbookXform.STATIC_XFORMS.calcPr\n  };\n};\n\nutils.inherits(WorkbookXform, BaseXform, {\n  WORKBOOK_ATTRIBUTES: {\n    xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\n    'xmlns:r': 'http://schemas.openxmlformats.org/officeDocument/2006/relationships',\n    'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\n    'mc:Ignorable': 'x15',\n    'xmlns:x15': 'http://schemas.microsoft.com/office/spreadsheetml/2010/11/main'\n  },\n  STATIC_XFORMS: {\n    fileVersion: new StaticXform({tag: 'fileVersion', $: {appName: 'xl', lastEdited: 5, lowestEdited: 5, rupBuild: 9303}}),\n    calcPr: new StaticXform({tag: 'calcPr', $: {calcId: 171027, iterate: true, iterateCount: 100, iterateDelta: \"0.001\"}})\n  }\n}, {\n\n  prepare: function(model) {\n    model.sheets = model.worksheets;\n\n    // collate all the print areas from all of the sheets and add them to the defined names\n    var printAreas = [];\n    var index = 0; // sheets is sparse array - calc index manually\n    model.sheets.forEach(function(sheet) {\n      if (sheet.pageSetup && sheet.pageSetup.printArea) {\n        const definedName = {\n          name: '_xlnm.Print_Area',\n          ranges: [sheet.name + '!' + sheet.pageSetup.printArea],\n          localSheetId: index\n        };\n        printAreas.push(definedName);\n      }\n      if (sheet.pageSetup && sheet.pageSetup.printTitlesRow) {\n        const titlesRows = sheet.pageSetup.printTitlesRow.split(':');\n        const definedName = {\n            name: '_xlnm.Print_Titles',\n            ranges: ['\\'' + sheet.name + '\\'!$' + titlesRows[0] + ':$' + titlesRows[1]],\n            localSheetId: index\n        };\n        printAreas.push(definedName);\n      }\n      index++;\n    });\n    if (printAreas.length) {\n      model.definedNames = model.definedNames.concat(printAreas);\n    }\n\n    model.media && model.media.forEach(function(medium, i) {\n      // assign name\n      medium.name = medium.type + (i + 1);\n    });\n  },\n\n  render: function(xmlStream, model) {\n    xmlStream.openXml(XmlStream.StdDocAttributes);\n    xmlStream.openNode('workbook', WorkbookXform.WORKBOOK_ATTRIBUTES);\n\n    this.map.fileVersion.render(xmlStream);\n    this.map.workbookPr.render(xmlStream, model.properties);\n    this.map.bookViews.render(xmlStream, model.views);\n    this.map.sheets.render(xmlStream, model.sheets);\n    this.map.definedNames.render(xmlStream, model.definedNames);\n    this.map.calcPr.render(xmlStream);\n\n    xmlStream.closeNode();\n  },\n\n  parseOpen: function(node) {\n    if (this.parser) {\n      this.parser.parseOpen(node);\n      return true;\n    }\n    switch (node.name) {\n      case 'workbook':\n        return true;\n      default:\n        this.parser = this.map[node.name];\n        if (this.parser) {\n          this.parser.parseOpen(node);\n        }\n        return true;\n    }\n  },\n  parseText: function(text) {\n    if (this.parser) {\n      this.parser.parseText(text);\n    }\n  },\n  parseClose: function(name) {\n    if (this.parser) {\n      if (!this.parser.parseClose(name)) {\n        this.parser = undefined;\n      }\n      return true;\n    }\n    switch (name) {\n      case 'workbook':\n        this.model = {\n          sheets: this.map.sheets.model,\n          properties: this.map.workbookPr.model || {},\n          views: this.map.bookViews.model\n        };\n        if (this.map.definedNames.model) {\n          this.model.definedNames = this.map.definedNames.model;\n        }\n\n        return false;\n      default:\n        // not quite sure how we get here!\n        return true;\n    }\n  },\n\n  reconcile: function(model) {\n    var rels = (model.workbookRels || []).reduce(function(map, rel) {\n      map[rel.Id] = rel;\n      return map;\n    }, {});\n\n    // reconcile sheet ids, rIds and names\n    var worksheets = [];\n    var worksheet;\n    var index = 0;\n\n    (model.sheets || []).forEach(function(sheet) {\n      var rel = rels[sheet.rId];\n      if (!rel) {\n        return;\n      }\n      worksheet = model.worksheetHash['xl/' + rel.Target];\n      // If there are \"chartsheets\" in the file, rel.Target will\n      // come out as chartsheets/sheet1.xml or similar here, and\n      // that won't be in model.worksheetHash.\n      // As we don't have the infrastructure to support chartsheets,\n      // we will ignore them for now:\n      if (worksheet) {\n        worksheet.name = sheet.name;\n        worksheet.id = sheet.id;\n        worksheets[index++] = worksheet;\n      }\n    });\n\n    // reconcile print areas\n    var definedNames = [];\n    _.each(model.definedNames, function(definedName) {\n      if (definedName.name === '_xlnm.Print_Area') {\n        worksheet = worksheets[definedName.localSheetId];\n        if (worksheet) {\n          if (!worksheet.pageSetup) {\n            worksheet.pageSetup = {};\n          }\n          const range = colCache.decodeEx(definedName.ranges[0]);\n          worksheet.pageSetup.printArea = range.dimensions;\n        }\n      } else if (definedName.name === '_xlnm.Print_Titles') {\n        worksheet = worksheets[definedName.localSheetId];\n        if (worksheet) {\n          if (!worksheet.pageSetup) {\n            worksheet.pageSetup = {};\n          }\n          const longRange = definedName.ranges[0].split('!');\n          const range = longRange[longRange.length - 1];\n          worksheet.pageSetup.printTitlesRow = range;\n        }\n      } else {\n        definedNames.push(definedName);\n      }\n    });\n    model.definedNames = definedNames;\n\n    // used by sheets to build their image models\n    model.media.forEach((media, i) => {\n      media.index = i;\n    });\n  }\n});\n"]}
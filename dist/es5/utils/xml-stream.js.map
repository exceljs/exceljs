{"version":3,"sources":["../../../lib/utils/xml-stream.js"],"names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","module","exports","_xml","_stack","_rollbacks","StdDocAttributes","version","encoding","standalone","prototype","tos","length","openXml","docAttributes","openNode","parent","open","leaf","addAttribute","Error","addAttributes","attrs","writeText","text","writeXml","closeNode","node","pop","leafNode","closeAll","addRollback","stack","commit","rollback","r","splice","join"],"mappings":"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","file":"xml-stream.js","sourcesContent":["/**\n * Copyright (c) 2016-2017 Guyon Roche\n * LICENCE: MIT - please refer to LICENCE file included with this module\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\n */\n\n'use strict';\n\nvar _ = require('./under-dash');\n\nvar utils = require('./utils');\n\n// constants\nvar OPEN_ANGLE = '<';\nvar CLOSE_ANGLE = '>';\nvar OPEN_ANGLE_SLASH = '</';\nvar CLOSE_SLASH_ANGLE = '/>';\nvar EQUALS_QUOTE = '=\"';\nvar QUOTE = '\"';\nvar SPACE = ' ';\n\nfunction pushAttribute(xml, name, value) {\n  xml.push(SPACE);\n  xml.push(name);\n  xml.push(EQUALS_QUOTE);\n  xml.push(utils.xmlEncode(value.toString()));\n  xml.push(QUOTE);\n}\nfunction pushAttributes(xml, attributes) {\n  if (attributes) {\n    _.each(attributes, function(value, name) {\n      if (value !== undefined) {\n        pushAttribute(xml, name, value);\n      }\n    });\n  }\n}\n\nvar XmlStream = module.exports = function() {\n  this._xml = [];\n  this._stack = [];\n  this._rollbacks = [];\n};\n\nXmlStream.StdDocAttributes = {\n  version: '1.0',\n  encoding: 'UTF-8',\n  standalone: 'yes'\n};\n\nXmlStream.prototype = {\n  get tos() {\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\n  },\n  \n  openXml: function(docAttributes) {\n    var xml = this._xml;\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n    xml.push('<?xml');\n    pushAttributes(xml, docAttributes);\n    xml.push('?>\\n');\n  },\n  \n  openNode: function(name, attributes) {\n    var parent = this.tos;\n    var xml = this._xml;\n    if (parent && this.open) {\n      xml.push(CLOSE_ANGLE);\n    }\n\n    this._stack.push(name);\n\n    // start streaming node\n    xml.push(OPEN_ANGLE);\n    xml.push(name);\n    pushAttributes(xml, attributes);\n    this.leaf = true;\n    this.open = true;\n  },\n  addAttribute: function(name, value) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    pushAttribute(this._xml, name, value);\n  },\n  addAttributes: function(attrs) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    pushAttributes(this._xml, attrs);\n  },\n  writeText: function(text) {\n    var xml = this._xml;\n    if (this.open) {\n      xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    xml.push(utils.xmlEncode(text.toString()));\n  },\n  writeXml: function(xml) {\n    if (this.open) {\n      this._xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    this._xml.push(xml);\n  },\n  closeNode: function() {\n    var node = this._stack.pop();\n    var xml = this._xml;\n    if (this.leaf) {\n      xml.push(CLOSE_SLASH_ANGLE);\n    } else {\n      xml.push(OPEN_ANGLE_SLASH);\n      xml.push(node);\n      xml.push(CLOSE_ANGLE);\n    }\n    this.open = false;\n    this.leaf = false;\n  },\n  leafNode: function(name, attributes, text) {\n    this.openNode(name, attributes);\n    if (text !== undefined) { // zeros need to be written\n      this.writeText(text);\n    }\n    this.closeNode();\n  },\n\n  closeAll: function() {\n    while (this._stack.length) {\n      this.closeNode();\n    }\n  },\n\n  addRollback: function() {\n    this._rollbacks.push({\n      xml: this._xml.length,\n      stack: this._stack.length,\n      leaf: this.leaf,\n      open: this.open\n    });\n  },\n  commit: function() {\n    this._rollbacks.pop();\n  },\n  rollback: function() {\n    var r = this._rollbacks.pop();\n    if (this._xml.length > r.xml) {\n      this._xml.splice(r.xml, this._xml.length - r.xml);\n    }\n    if (this._stack.length > r.stack) {\n      this._stack.splice(r.stack, this._stack.length - r.stack);\n    }\n    this.leaf = r.leaf;\n    this.open = r.open;\n  },\n\n  get xml() {\n    this.closeAll();\n    return this._xml.join('');\n  }\n};\n"]}